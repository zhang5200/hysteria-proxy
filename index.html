<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hysteria User Management</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        margin-bottom: 20px;
        color: #333;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f8f9fa;
        font-weight: 600;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: white;
        margin-right: 5px;
      }
      .btn-primary {
        background-color: #007bff;
      }
      .btn-danger {
        background-color: #dc3545;
      }
      .btn-success {
        background-color: #28a745;
      }
      .btn-warning {
        background-color: #ffc107;
        color: #333;
      }
      .status-enabled {
        color: green;
        font-weight: bold;
      }
      .status-disabled {
        color: red;
        font-weight: bold;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background: white;
        width: 400px;
        padding: 20px;
        margin: 100px auto;
        border-radius: 8px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h1>Hysteria Users</h1>
        <button class="btn btn-primary" onclick="showAddModal()">
          + Add User
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Password</th>
            <th>Status</th>
            <th>Traffic (Up/Down)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTable">
          <!-- Users will be loaded here -->
        </tbody>
      </table>
    </div>

    <!-- Modal -->
    <div id="userModal" class="modal">
      <div class="modal-content">
        <h2 id="modalTitle">Add User</h2>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="usernameInput" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" id="passwordInput" />
        </div>
        <div style="text-align: right">
          <button class="btn btn-warning" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveUser()">Save</button>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "/api/users";
      let users = [];

      async function loadUsers() {
        try {
          const res = await fetch(API_URL);
          users = await res.json();
          renderUsers();
        } catch (err) {
          console.error("Failed to load users", err);
        }
      }

      function formatBytes(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function renderUsers() {
        const tbody = document.getElementById("userTable");
        tbody.innerHTML = "";
        users.forEach((user) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.password}</td>
                    <td class="${
                      user.enabled ? "status-enabled" : "status-disabled"
                    }">
                        ${user.enabled ? "Active" : "Disabled"}
                    </td>
                    <td>
                        ↑ ${formatBytes(user.tx)} <br>
                        ↓ ${formatBytes(user.rx)}
                    </td>
                    <td>
                        <button class="btn ${
                          user.enabled ? "btn-warning" : "btn-success"
                        }" 
                            onclick="toggleUser(${
                              user.id
                            }, ${!user.enabled}, '${user.password}')">
                            ${user.enabled ? "Disable" : "Enable"}
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser(${
                          user.id
                        })">Delete</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      async function saveUser() {
        const username = document.getElementById("usernameInput").value;
        const password = document.getElementById("passwordInput").value;

        if (!username || !password) return alert("Please fill in all fields");

        try {
          await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ username, password }),
            headers: { "Content-Type": "application/json" },
          });
          closeModal();
          loadUsers();
        } catch (err) {
          alert("Failed to save user");
        }
      }

      async function deleteUser(id) {
        if (!confirm("Are you sure?")) return;
        await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        loadUsers();
      }

      async function toggleUser(id, enabled, password) {
        await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          body: JSON.stringify({ enabled, password }),
          headers: { "Content-Type": "application/json" },
        });
        loadUsers();
      }

      function showAddModal() {
        document.getElementById("userModal").style.display = "block";
        document.getElementById("modalTitle").innerText = "Add User";
        document.getElementById("usernameInput").value = "";
        document.getElementById("passwordInput").value = "";
      }

      function closeModal() {
        document.getElementById("userModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("userModal")) {
          closeModal();
        }
      };

      // Auto refresh every 10 seconds
      loadUsers();
      setInterval(loadUsers, 10000);
    </script>
  </body>
</html>
